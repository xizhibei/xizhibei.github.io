<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="技术分享 | Node.js | kubernetes | ansible | Docker | DevOps | 思维与认知"><title>监控利器之 Prometheus | 须臾之学</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-91452326-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">监控利器之 Prometheus</h1><a id="logo" href="/.">须臾之学</a><p class="description">别瞎想，多走走，多看书</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">监控利器之 Prometheus</h1><div class="post-meta">2017-08-06<span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 4</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><!-- en_title:monitoring-with-prometheus -->

<p>一直以来，我们会在项目中，使用 APM 去监控应用的状况，分析性能等，这些工具很有效，而且不侵入业务，不需要埋点。</p>
<p>然而，有些需求，是 APM 的监控满足不了的，比如<strong>应用业务指标</strong>。</p>
<h3 id="监控模式"><a href="#监控模式" class="headerlink" title="监控模式"></a>监控模式</h3><p>目前，采集指标有两种方式，一种是『推』，另一种就是『拉』：</p>
<p>推的代表有 ElasticSearch，InfluxDB，OpenTSDB 等，需要你从程序中将指标使用 TCP，UDP 等方式推送至相关监控应用，只是使用 TCP 的话，一旦监控应用挂掉或存在瓶颈，容易对应用本身产生影响，而使用 UDP 的话，虽然不用担心监控应用，但是容易丢数据。</p>
<p>拉的代表，主要代表就是 Prometheus，让我们不用担心监控应用本身的状态。而且，可以利用 DNS-SRV 或者 Consul 等服务发现功能就可以自动添加监控。</p>
<p>当然，InfluxDB 加上 collector，或者 ES 加上 metricbeat 也可以变为 『拉』，而 Prometheus 加上 Push Gateway 也可以变为 『推』。</p>
<p>接下来，我们主要介绍下 Prometheus。</p>
<h3 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h3><p>『普罗米修斯』，也是希腊之神，取义『先见之明』，应该就是监控的意义所在吧。</p>
<p>它跟 k8s 一样，也是依据 Google 内部的应用原理设计来的，可以看作是 Google 内部监控系统 Borgmon 的一个实现。</p>
<p>架构图如下（来自 Prometheus <a target="_blank" rel="noopener" href="https://prometheus.io/docs/introduction/overview/">官方文档</a>）：</p>
<p><img src="https://prometheus.io/assets/architecture.svg"></p>
<p>Prometheus 可以从配置或者用服务发现，去调用各个应用的 metrics 接口，来采集数据，然后存储在硬盘中，而如果是基础应用比如数据库，负载均衡器等，可以在相关的服务中安装 Exporters 来提供 metrics 接口供 Prometheus 拉取。</p>
<p>采集到的数据有两个去向，一个是报警，另一个是可视化。</p>
<p>下面将一一介绍。</p>
<h3 id="Metrics-格式"><a href="#Metrics-格式" class="headerlink" title="Metrics 格式"></a>Metrics 格式</h3><pre><code>&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;
</code></pre>
<p>各个部分需符合相关的正则表达式</p>
<ul>
<li>  metric name: [a-zA-Z_:][a-zA-Z0-9_:]*</li>
<li>  label name: [a-zA-Z0-9_]*</li>
<li>  label value: .* (即不限制)</li>
</ul>
<p>需要注意的是，label value 最好使用枚举值，而不要使用无限制的值，比如用户 ID，Email 等，不然会消耗大量内存，也不符合指标采集的意义。</p>
<h3 id="Metrics-接口的实现"><a href="#Metrics-接口的实现" class="headerlink" title="Metrics 接口的实现"></a>Metrics 接口的实现</h3><p>大部分语言都有提供客户端，比如 Node.js 的客户端 <a target="_blank" rel="noopener" href="https://github.com/siimon/prom-client">prom-client</a>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install prom-client --save</span><br></pre></td></tr></table></figure>
<p>目前，这个客户端提供了完整功能，可以在应用中埋点采集数据，比如</p>
<ul>
<li>  今天注册了多少用户，收入了多少钱，可以使用 <code>Counter</code>;</li>
<li>  Node 内存以及 CPU 的变化，可以使用 <code>Gause</code>；</li>
<li>  API 接口响应时间的统计，可以使用 <code>Histogram</code> 或者 <code>Summary</code>，前者可以按照具体数值，而后者可以按照百分比去统计响应时长；</li>
</ul>
<p>对了，这个包内部提供了采集默认数据的功能，比如 Node 相关的指标：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> promClient = <span class="built_in">require</span>(<span class="string">&#x27;prom-client&#x27;</span>);</span><br><span class="line"></span><br><span class="line">promClient.collectDefaultMetrics(&#123;</span><br><span class="line">    timeout: <span class="number">5000</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="报警"><a href="#报警" class="headerlink" title="报警"></a>报警</h3><p>你可以根据业务需求，来定制相关的规则去报警，然后关键就来了，你是否在传统的短信或者邮件报警中感到厌烦呢？</p>
<p>一方面，当线上问题出现的时候，我们会收到大量的报警消息，而其中很大一部分是重复的；另一方面，收到没用的报警，或者报警级别不高，导致这时候如果有重要的报警，会被我们忽略。</p>
<p>Prometheus 的 AlertManager 提供了解决这些问题的各种高级报警功能。</p>
<ul>
<li>  <strong>报警分组</strong>：将报警分组，当报警大量出现的时候，只会发一条消息告诉你数据库挂了的情况出现了 100 次，而不是用 100 条推送轰炸你；</li>
<li>  <strong>报警抑制</strong>：显然，当数据库出问题的时候，其它的应用可肯定会出问题，这时候你可能不会需要其它的不相干的报警短信，这个功能将真正有用的信息及时通知你；</li>
<li>  <strong>报警静默</strong>：一些不重要的报警，可以完全忽略，因此也就没有必要通知；</li>
</ul>
<p>报警通知的方式，目前可以通过 webhook, email 等方式，估计微信或者钉钉也可以，我目前使用的是 slack。</p>
<h3 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h3><p>首选当然是 Grafana，Prometheus 自己放弃了 PromDash 的可视化工具，而专注于监控数据采集与分析。在 Grafana 中配置 Prometheus 也很简单，在配置好数据源之后，可以直接创建图表。</p>
<p>需要注意的是，你会需要用到 Prometheus 专用的<a target="_blank" rel="noopener" href="https://prometheus.io/docs/querying/basics/">查询语言</a>去配置数据，其中如果涉及到的图表内容太多，你可能会需要用到 Grafana 的模板：</p>
<ul>
<li>  label_values(label)：全局中 label 值的集合；</li>
<li>  label_values(metric, label)：某个 metric 的 label 值的集合；</li>
<li>  metrics(metric)：metric 的正则表达集合，返回全部匹配的 metric；</li>
<li>  query_result(query)：返回查询集合；</li>
</ul>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h3><ul>
<li>  <a target="_blank" rel="noopener" href="https://prometheus.io/docs/operating/configuration/">https://prometheus.io/docs/operating/configuration/</a></li>
<li>  <a target="_blank" rel="noopener" href="https://prometheus.io/blog/2015/06/01/advanced-service-discovery/">https://prometheus.io/blog/2015/06/01/advanced-service-discovery/</a></li>
<li>  <a target="_blank" rel="noopener" href="http://docs.grafana.org/features/datasources/prometheus/">http://docs.grafana.org/features/datasources/prometheus/</a></li>
</ul>
<hr>
<p>首发于 Github issues: <a target="_blank" rel="noopener" href="https://github.com/xizhibei/blog/issues/54">https://github.com/xizhibei/blog/issues/54</a> ，欢迎 Star 以及 Watch</p>
<b>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">署名-非商业性使用-相同方式共享（BY-NC-SA）</a>进行许可</b>
<br/>
<b>作者：<a href="https://blog.xizhibei.me/about/" target="_blank">习之北 (@xizhibei)</a></b>
<br/>
<b>原链接：<a href="https://blog.xizhibei.me/2017/08/06/monitoring-with-prometheus/" target="_blank">https://blog.xizhibei.me/2017/08/06/monitoring-with-prometheus/</a></b>
<br/>

<hr>
</div><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://blog.xizhibei.me/2017/08/06/monitoring-with-prometheus/" data-id="cko5wqfpi006a36shbyt9a6zr" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACrklEQVR42u3a0WrjQAwF0Pz/T2dhnxYW21fSqLhw/FRSNzPHhYxypc8nvr5/r+Sef++8+qvvf9fVWvd3Hrvw8PDwWlu/uu63foVJ3u3+8eX7eXgEeHh4eGu8+8Mgh+VHwt6Rg4eHh/ceXlL+bpfXeHh4eL+XV10sKYvzMAIPDw/vDbw8Pkg+xPOP/h5pJWvBw8PDi3nVBtgbfl7s7+Hh4eENuurVxlj1wMhL7eYO8fDw8BZ41SGn6kZ7razew42yFjw8PLwxr9p2mgxIVUOEZFcPRTYeHh7eAq8aQMwbXb3Rq4RRBuPh4eG1eHmBW21N9Urks6vg4eHh/QwvPyp6TbL8/gNFNh4eHt4Cr9qO6oW/vQIdDw8P7828/Kt+9ZXq8dMrzR/2gIeHh7fAy9tU91uvRgxJCZ4HvqP5CDw8PLyYl9yaBKzJVuaPqRz44uHh4S3wclJvgfwjvjdElQ8f4OHh4Z3iHRj6jAviZK35gTTq7+Hh4eG1ePmIVfL62TK6vCIeHh7eAi8plJtf/oPlT0XDD+U1Hh4e3gJvMoCVj2fly+eYasmOh4eHN+clEW11E6feYf4I8PDw8PZ4p4alJo2xapgb/RYPDw9vgTcfFEji3WSVPCbutdbw8PDwTvHmwUH1WVabXvk/o5lP4+Hh4RV51fGmZihQDD4mZT0eHh7eNi+PIaqbyBtXpwLiy5IaDw8P7yhv3rzPP+h7IwhnC3o8PDy8Oe9bvPIWVzW6ncTEDzEuHh4e3lFefuXNp0k0nBfxk4MEDw8Pb87Lm1LNeYRi2V1lPOwEDw8Pb413qgjOA4i8ATbKWvDw8PBew5tHBnmZ3htWwMPDw3sDrzqqlZfp1aOoMGqAh4eHt8brbaXaxJo81l5DDg8PD2+DNw9hJ4FFj5EfJHh4eHhHeX8ANhHaT1lJK4kAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/%E7%9B%91%E6%8E%A7/"><i class="fa fa-tag"></i>监控</a><a href="/tags/DevOps/"><i class="fa fa-tag"></i>DevOps</a><a href="/tags/Prometheus/"><i class="fa fa-tag"></i>Prometheus</a></div><div class="post-nav"><a class="pre" href="/2017/08/19/deploy-prometheus-in-k8s/">在 k8s 中部署 Prometheus</a><a class="next" href="/2017/07/09/cong-ba--sla--jia-jin--kpi--kao-he-shuo-qi/">从把 SLA 加进 KPI 考核说起</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://blog.xizhibei.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E6%96%87%E6%A1%A3/" style="font-size: 15px;">文档</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 15px;">总结</a> <a href="/tags/%E8%81%8C%E5%9C%BA/" style="font-size: 15px;">职场</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/CMake/" style="font-size: 15px;">CMake</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E9%89%B4%E4%B9%A6/" style="font-size: 15px;">鉴书</a> <a href="/tags/%E6%97%85%E8%A1%8C/" style="font-size: 15px;">旅行</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 15px;">生活</a> <a href="/tags/%E8%A7%86%E9%A2%91%E7%9B%B4%E6%92%AD/" style="font-size: 15px;">视频直播</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 15px;">监控</a> <a href="/tags/%E9%87%8D%E6%9E%84/" style="font-size: 15px;">重构</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/ELK/" style="font-size: 15px;">ELK</a> <a href="/tags/Elasticsearch/" style="font-size: 15px;">Elasticsearch</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 15px;">基础知识</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/TypeScript/" style="font-size: 15px;">TypeScript</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/" style="font-size: 15px;">年度总结</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 15px;">架构</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="font-size: 15px;">系统设计</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/%E5%B7%A5%E4%BD%9C%E6%96%B9%E6%B3%95/" style="font-size: 15px;">工作方法</a> <a href="/tags/%E4%BC%81%E4%B8%9A%E6%96%87%E5%8C%96/" style="font-size: 15px;">企业文化</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/ansible/" style="font-size: 15px;">ansible</a> <a href="/tags/Gitlab/" style="font-size: 15px;">Gitlab</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 15px;">测试</a> <a href="/tags/%E6%B2%9F%E9%80%9A/" style="font-size: 15px;">沟通</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/" style="font-size: 15px;">系统思考</a> <a href="/tags/Prometheus/" style="font-size: 15px;">Prometheus</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 15px;">微服务</a> <a href="/tags/%E5%88%9B%E4%B8%9A/" style="font-size: 15px;">创业</a> <a href="/tags/C-x2F-C/" style="font-size: 15px;">C&#x2F;C++</a> <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/%E4%B8%9A%E5%8A%A1/" style="font-size: 15px;">业务</a> <a href="/tags/Helm/" style="font-size: 15px;">Helm</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 15px;">配置</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 15px;">管理</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 15px;">安全</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 15px;">反爬虫</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a> <a href="/tags/%E6%8B%9B%E8%81%98/" style="font-size: 15px;">招聘</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 15px;">面试</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 15px;">读书</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">翻译</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/01/linux-time-hwclock/">Linux 时间之 hwclock</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/28/netflix-no-rules-rules/">不拘一格的网飞</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/22/engineer-s-tsundere/">工程师的傲骄</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/12/cmake-shared-lib-absolute-path-problem/">CMake 动态链接库绝对路径问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/12/a-brief-intro-of-rpath/">RPATH 简介以及 CMake 中的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/03/https-two-way-authentication-with-certificates/">HTTPS 双向证书认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/10/poor-mans-profiler/">穷人的程序性能分析器</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/01/summary-of-2020/">2020 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/a-simple-implementation-of-rtsp-server/">RTSP 服务器的简单实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/21/disk-cache-start-with-a-file-missing-problem/">磁盘缓存：从一次文件丢失问题说起</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">须臾之学.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>