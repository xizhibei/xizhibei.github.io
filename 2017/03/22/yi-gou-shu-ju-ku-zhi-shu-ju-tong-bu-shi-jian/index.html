<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="技术分享 | Node.js | kubernetes | ansible | Docker | DevOps | 思维与认知"><title>异构数据库之数据同步实践 | 须臾之学</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-91452326-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">异构数据库之数据同步实践</h1><a id="logo" href="/.">须臾之学</a><p class="description">别瞎想，多走走，多看书</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">异构数据库之数据同步实践</h1><div class="post-meta">2017-03-22<span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.1k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 3</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>一般来说，我们的不少业务中，需要用到数据同步，而其中涉及到的本质无非是 <strong>『数据一致性』</strong>。首先，能想到的数据同步的例子肯定是数据库，由于数据库领域存在的 CAP 理论，一定会有数据同步的过程来达到数据一致性，只是那是属于相同数据库之间的同步，在不同数据库的情况下同步数据的话，叫做 <strong>『异构同步』</strong>。</p>
<p>不过目前先放下一致性原理，以现有的一个业务场景为例，来说说如何实现异构同步。</p>
<h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>线上有一个采取了分表与分库的 MySQL 数据库集群，主要存放订单等数据，业务上想要看到订单的统计结果，但是如果直接在集群上跑脚本的话，容易将数据库拖垮，因此，需要同步数据至其它数据源进行统计，比如 ES、HBase 等。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><h4 id="完整克隆"><a href="#完整克隆" class="headerlink" title="完整克隆"></a>完整克隆</h4><p>这个最容易想到，数据库 A 完整导出数据，然后导入至数据库 B，缺点显而易见，不适用于持续增长的数据，可以勉强适用于每天导出部分数据，然后用 Excel 统计。（对的，一开始业务部门要数据的时候，你就会这么干，如果你还在这么干的话，考虑下其它方案吧，后期他们一遍又一遍来找你导数据的时候，你会发飙的。）</p>
<h4 id="标记同步"><a href="#标记同步" class="headerlink" title="标记同步"></a>标记同步</h4><p>如果业务简单，插入到数据库中的数据不会发生变化，即日志型数据表，这时候就可以根据标记，比如 ** 时间戳 ** 来同步，即使发生故障，也可以从上一次同步的位置开始重新同步。</p>
<h4 id="实时同步"><a href="#实时同步" class="headerlink" title="实时同步"></a>实时同步</h4><p>即将线上产生的数据，实时写到两个数据库，显然会拖慢应用，可以考虑做成离线的后台任务队列去做。只是在数据实时性要求不是那么高的情况下，不建议使用。</p>
<h4 id="数据库日志同步"><a href="#数据库日志同步" class="headerlink" title="数据库日志同步"></a>数据库日志同步</h4><p>比如 MySQL 的 binlog，MongoDB 的 oplog，包含了所有的数据库记录变动记录，可以解析相应的 log 数据格式，来达到完全同步到其它数据库的目的。这种方法兼容程度高，几乎不会丢数据，只是可能需要较多的开发，工具的话也有，目前还没有尝试过。</p>
<p>需要提醒的一点是：如果是云服务器厂商提供的数据库实例，可能你无法获取相应的 log，就比如 MySQL 的 binlog 。即使你能获取，还有一点很头疼的是，你需要将 binlog 设置成 <strong>row</strong> 模式，才能去同步，这样会造成 binlog 非常大，高写入场景下不适合。</p>
<h3 id="一些-Node-js-数据同步脚本实践经验"><a href="#一些-Node-js-数据同步脚本实践经验" class="headerlink" title="一些 Node.js 数据同步脚本实践经验"></a>一些 Node.js 数据同步脚本实践经验</h3><p>首先是几个比较好用的 cli 工具：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/tj/commander.js">commander</a>：用来处理命令行参数，另外还有个最近出来，挺火的：<a target="_blank" rel="noopener" href="https://github.com/mattallty/Caporal.js">Caporal.js</a>；</li>
<li><a target="_blank" rel="noopener" href="https://github.com/chalk/chalk">chalk</a>：输出各种颜色，用来调节写脚本时候郁闷的心情；</li>
<li><a target="_blank" rel="noopener" href="https://github.com/tj/node-progress">progress</a>：进度条，不知道同步进度的时候会很蛋疼，而一直用 <code>console.log</code> 或者 <code>debug</code> 的话，容易输出一堆没用的 log 。（相信我，当你同事看到进度条在刷刷的动的时候，尤其是产品🐶，他们会用崇拜的眼神来看你的 😝）；</li>
</ul>
<p>然后，注意内存，同步脚本的时候，这个脚本所占的内存会比较大，可以考虑设置大一些：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node --max-old-space-size=<span class="number">2000</span> ./script.js</span><br></pre></td></tr></table></figure>
<p>还有并发数，如果开的比较高，需要注意 ** 连接池 **。</p>
<p>最后，如果使用 http 协议发送数据，则需要在跑脚本的机器上设置文件句柄限制（数字自己调整即可，这里只是个例子）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n 100000000</span><br></pre></td></tr></table></figure>


<hr>
<p>首发于 Github issues: <a target="_blank" rel="noopener" href="https://github.com/xizhibei/blog/issues/43">https://github.com/xizhibei/blog/issues/43</a> ，欢迎 Star 以及 Watch</p>
<b>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">署名-非商业性使用-相同方式共享（BY-NC-SA）</a>进行许可</b>
<br/>
<b>作者：<a href="https://blog.xizhibei.me/about/" target="_blank">习之北 (@xizhibei)</a></b>
<br/>
<b>原链接：<a href="https://blog.xizhibei.me/2017/03/22/yi-gou-shu-ju-ku-zhi-shu-ju-tong-bu-shi-jian/" target="_blank">https://blog.xizhibei.me/2017/03/22/yi-gou-shu-ju-ku-zhi-shu-ju-tong-bu-shi-jian/</a></b>
<br/>

<hr>
</div><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://blog.xizhibei.me/2017/03/22/yi-gou-shu-ju-ku-zhi-shu-ju-tong-bu-shi-jian/" data-id="cko5wqfqx009n36sh86rpeuyf" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACs0lEQVR42u3ay47iMBAFUP7/p5nttKDDrYcjWjpZIcjDJwu7uOXHIz6eL8f/37+eef3N6z1fz0yetXbg4eHhjYf+261/+yYfxDUmf03JmPHw8PBO8yZDSV5Bjs9f9/WY8fDw8L6Hl0/Wea2b18Z4eHh4f5dXLXCrsULvDnh4eHh38nYH1wsjrpeW41kLHh4eXsybD+v+z0f6e3h4eHjjrvpku0D+a7IwPFsHHh4e3gne/PHVwCIvoLciDDw8PLxdXj4RJ5sDkhChWjTn1745Bw8PD+8A755YthfFrhXueHh4eMd41Uk/f1i+gTXh5csYHh4e3jneh6yi9QoSfPXMSUiBh4eHt8vbXQDmg55HIW/CCDw8PLwbeUlgOm9iTWKIchiBh4eHN+DNC+Xq9H3d1poEuG/uj4eHh3eANw8UtsrlSYbwYeHBw8PDW+XlBW4y3fc2JeTNsLz19WPdw8PDw1vlXQ+lWijnrbXJnUebBvDw8PDGvEmDf6tB1Ys8olIeDw8P7wBvcotqSV2NbpM8oaDAw8PDW+X1ItdncOQNsGoRnwe7eHh4eLu83t/+R/HoFdm9bVuFtQ4PDw9vwJs3pfKgNpnQE0zhXwIeHh7eKq86uVcf34tr8y1cyUKCh4eHdz9veYdC8SVWg5LyGPDw8PBavGojqhfsVttg+efCpgE8PDy8VV4OzgOIPGLo9e7w8PDwvpNXHW51A0EeZzT/AODh4eGt8p7Fo1eC9wbdW65+/IqHh4d3gDdvgFWn+OvXUV1+kmYYHh4e3gleNX7NS+3eMtCb+gspNR4eHt4SL3lk3riaLxWjfAUPDw/vK3nVwrcaOuRja+rx8PDwbuflpe1kE0AeLuPh4eHdz5s3vZJwIVlgqud8uBYPDw/vAK9Xl042VOVTfDViXssz8PDw8N5f+w+FgzXK+tqClwAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><i class="fa fa-tag"></i>数据库</a><a href="/tags/Node-js/"><i class="fa fa-tag"></i>Node.js</a></div><div class="post-nav"><a class="pre" href="/2017/03/29/%E3%80%8A-mu-biao-%E3%80%8B-du-hou-gan/">《目标》读后感</a><a class="next" href="/2017/03/09/chi-xu-jiao-fu-de-shi-jian-yu-si-kao/">持续交付的实践与思考</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://blog.xizhibei.me"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E6%96%87%E6%A1%A3/" style="font-size: 15px;">文档</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 15px;">总结</a> <a href="/tags/%E8%81%8C%E5%9C%BA/" style="font-size: 15px;">职场</a> <a href="/tags/C-C/" style="font-size: 15px;">C/C++</a> <a href="/tags/CMake/" style="font-size: 15px;">CMake</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E9%89%B4%E4%B9%A6/" style="font-size: 15px;">鉴书</a> <a href="/tags/%E6%97%85%E8%A1%8C/" style="font-size: 15px;">旅行</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 15px;">生活</a> <a href="/tags/%E8%A7%86%E9%A2%91%E7%9B%B4%E6%92%AD/" style="font-size: 15px;">视频直播</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E7%9B%91%E6%8E%A7/" style="font-size: 15px;">监控</a> <a href="/tags/%E9%87%8D%E6%9E%84/" style="font-size: 15px;">重构</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/ELK/" style="font-size: 15px;">ELK</a> <a href="/tags/Elasticsearch/" style="font-size: 15px;">Elasticsearch</a> <a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 15px;">基础知识</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/TypeScript/" style="font-size: 15px;">TypeScript</a> <a href="/tags/gRPC/" style="font-size: 15px;">gRPC</a> <a href="/tags/%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/" style="font-size: 15px;">年度总结</a> <a href="/tags/RabbitMQ/" style="font-size: 15px;">RabbitMQ</a> <a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 15px;">架构</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="font-size: 15px;">系统设计</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/%E5%B7%A5%E4%BD%9C%E6%96%B9%E6%B3%95/" style="font-size: 15px;">工作方法</a> <a href="/tags/%E4%BC%81%E4%B8%9A%E6%96%87%E5%8C%96/" style="font-size: 15px;">企业文化</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/ansible/" style="font-size: 15px;">ansible</a> <a href="/tags/Gitlab/" style="font-size: 15px;">Gitlab</a> <a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 15px;">测试</a> <a href="/tags/%E6%B2%9F%E9%80%9A/" style="font-size: 15px;">沟通</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E6%80%9D%E8%80%83/" style="font-size: 15px;">系统思考</a> <a href="/tags/Prometheus/" style="font-size: 15px;">Prometheus</a> <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 15px;">微服务</a> <a href="/tags/%E5%88%9B%E4%B8%9A/" style="font-size: 15px;">创业</a> <a href="/tags/C-x2F-C/" style="font-size: 15px;">C&#x2F;C++</a> <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/%E4%B8%9A%E5%8A%A1/" style="font-size: 15px;">业务</a> <a href="/tags/Helm/" style="font-size: 15px;">Helm</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 15px;">配置</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/%E7%AE%A1%E7%90%86/" style="font-size: 15px;">管理</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 15px;">安全</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/%E5%8F%8D%E7%88%AC%E8%99%AB/" style="font-size: 15px;">反爬虫</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a> <a href="/tags/%E6%8B%9B%E8%81%98/" style="font-size: 15px;">招聘</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 15px;">面试</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 15px;">读书</a> <a href="/tags/PGP/" style="font-size: 15px;">PGP</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">翻译</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/01/linux-time-hwclock/">Linux 时间之 hwclock</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/28/netflix-no-rules-rules/">不拘一格的网飞</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/22/engineer-s-tsundere/">工程师的傲骄</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/12/cmake-shared-lib-absolute-path-problem/">CMake 动态链接库绝对路径问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/12/a-brief-intro-of-rpath/">RPATH 简介以及 CMake 中的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/03/https-two-way-authentication-with-certificates/">HTTPS 双向证书认证</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/10/poor-mans-profiler/">穷人的程序性能分析器</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/01/summary-of-2020/">2020 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/a-simple-implementation-of-rtsp-server/">RTSP 服务器的简单实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/21/disk-cache-start-with-a-file-missing-problem/">磁盘缓存：从一次文件丢失问题说起</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">须臾之学.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>